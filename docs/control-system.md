# 操作体系仕様

## 概要

この操作体系は、ぷよ操作の高速化とミスの削減を目的としています。
フィールドエリアと操作エリアの両方で同じ操作が可能で、ハイライト状態は両エリアで同期されます。

## UI構成

### フィールド
- 6列 x 12行のぷよフィールド（+ 隠しマス1行）
- 右寄せ配置（右利き用）/ 左寄せ配置（左利き用）
- タッチ操作対応（FieldInput でラップ）

### 操作エリア
- フィールド下部に配置
- フィールドと同じ幅（6列分 + ボーダー）
- 高さ: セルサイズ x 3
- 6列の区切り線でタップ位置を視覚化
- スワイプガイド矢印（中央に表示、アクティブ方向がハイライト）

### 予告ぷよ（NEXT）
- フィールド右上にオーバーレイ表示
- 2つ先まで表示

## 操作方法

### 操作可能エリア

**フィールドエリア**と**操作エリア**の両方で同じ操作が可能:
- フィールド上で直接操作すると、落下位置を見ながら操作できる
- 操作エリアで操作すると、フィールド表示を隠さずに操作できる

### 基本操作フロー

1. **タッチ開始**: フィールドまたは操作エリア内でタッチ
   - タッチした列に軸ぷよ（下側のぷよ）が移動
   - サテライト（上側のぷよ）は上向きに初期化
   - 両エリアで該当列がハイライト

2. **スワイプ**: 手を離さずにスワイプ
   - サテライトの向きを変更
   - スワイプ方向のインジケーターが表示

3. **リリース**: 手を離す
   - 配置確定状態: ハードドロップ（即座に落下・固定）
   - キャンセル待ち状態: 操作キャンセル（中央に戻る）

### スワイプ方向とサテライト配置

| スワイプ方向 | サテライト位置 |
|-------------|--------------|
| 上スワイプ   | 下           |
| 下スワイプ   | 上           |
| 左スワイプ   | 左           |
| 右スワイプ   | 右           |

### キャンセル操作

スワイプ後に元の位置（タッチ開始位置の近く）に戻すと「キャンセル待ち状態」になります。
この状態で手を離すと、操作がキャンセルされ、ぷよは中央（3列目）に戻ります。

### 配置不可時の動作

タッチした列にぷよを配置できない場合（列が埋まっている場合など）:
- 該当列が赤くハイライト
- エラー触覚フィードバック
- 手を離しても何も起きない（キャンセル扱い）

## 視覚的フィードバック

### ハイライト同期

フィールドと操作エリアの状態は `gestureStore` で共有され、常に同期:
- **アクティブ列**: 青色ハイライト
- **ブロック列**: 赤色ハイライト
- **キャンセル時**: オレンジ色で点滅

### スワイプインジケーター

- **フィールド**: 中央に丸いインジケーターと矢印
- **操作エリア**: 十字の矢印ガイド（アクティブ方向が発光）

## 状態遷移

```
初期状態 (idle)
    ↓ タッチ開始（配置可能な列）
操作中状態 (touching)
    ↓ スワイプ（閾値超過）
配置確定状態 (swiped)
    ├→ 手を離す → ハードドロップ → 初期状態
    └→ 元の位置に戻す
         ↓
キャンセル待ち状態 (cancelPending)
    └→ 手を離す → キャンセル → 初期状態

初期状態 (idle)
    ↓ タッチ開始（配置不可な列）
ブロック状態 (blocked)
    └→ 手を離す → 何もしない → 初期状態
```

## 閾値設定

- スワイプ検出閾値: 20px
- キャンセル判定閾値: 15px

## 技術的詳細

### アーキテクチャ

```
┌─────────────────┐    ┌─────────────────┐
│   FieldInput    │    │  ControlArea    │
│  (フィールド用)   │    │  (操作エリア用)  │
└────────┬────────┘    └────────┬────────┘
         │                      │
         └──────────┬───────────┘
                    ↓
         ┌─────────────────────┐
         │   useFieldGesture   │  ← PanResponder ロジック
         └──────────┬──────────┘
                    ↓
         ┌─────────────────────┐
         │    gestureStore     │  ← ハイライト状態の共有
         └─────────────────────┘
```

### 関連ファイル

| ファイル | 役割 |
|---------|------|
| `src/input/FieldInput.tsx` | フィールド入力ラッパー |
| `src/input/ControlAreaInput.tsx` | 操作エリアコンポーネント |
| `src/input/useFieldGesture.ts` | ジェスチャー処理フック |
| `src/input/gestureStore.ts` | ハイライト状態の共有ストア |
| `src/store/gameStore.ts` | アクションハンドラ |
| `src/logic/puyo.ts` | setColumn, setRotation 関数 |

### ストア

#### gestureStore

ハイライト状態を共有するための Zustand ストア:

```typescript
interface GestureState {
  activeColumn: number | null;      // アクティブな列
  blockedColumn: number | null;     // ブロックされた列
  swipeDirection: 'up' | 'down' | 'left' | 'right' | null;
  cancelFlash: boolean;             // キャンセル時の点滅
}
```

### アクション

- `SET_COLUMN`: 軸ぷよの列を直接設定
- `SET_ROTATION`: サテライトの向き（0:上, 1:右, 2:下, 3:左）を直接設定
- `HARD_DROP`: 即座に落下・固定
